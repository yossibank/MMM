#!/usr/bin/env sh

# ãƒ†ã‚­ã‚¹ãƒˆã‚’èµ¤è‰²ã«è‰²ä»˜ã‘
color_red () {
  ESC=$(printf '\033')
  printf "$ESC[31m$1$ESC[m"
}

# SwiftFormat
command="swift run --package-path BuildTools swiftformat"

# SwiftFormat ãŒã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ä¸Šã§å®Ÿè¡Œã§ãã‚‹ã‹ç¢ºèª
command -v $command 1>/dev/null 2>&1
if [ $? -gt 0 ]; then
  echo $(color_red "ğŸ˜“ swiftformat ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
  exit 1
fi

# å¤±æ•—ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
should_fail=false

# git ã§ staging ã•ã‚ŒãŸ swift ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
staged_swift_files=`git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$'`

# staging ã•ã‚ŒãŸ swift ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯çµ‚äº†
if [ -z "$staged_swift_files" ]; then
  exit 0
fi

# staging ã•ã‚ŒãŸ swift ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
while read file; do
  # staging ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ã®ãƒ‘ãƒƒãƒã‚’å–å¾—
  unstaged_patch=$(git diff "$file")

  # stagingã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
  if [ ! -z "$unstaged_patch" ]; then
    # staging ã‹ã‚‰å‰Šé™¤
    git restore $file
  fi

  # SwiftFormat ã®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
  echo "ğŸ‘ SwiftFormat: ç¢ºèªä¸­... $file"
  # lint ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç¢ºèª(å¤‰æ›´ã¯ç™ºç”Ÿã—ãªã„)
  $command --lint $file

  # ã‚¨ãƒ©ãƒ¼ãŒãªã‹ã£ãŸå ´åˆ
  if [ $? -eq 0 ]; then
    # staging ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
    if [ ! -z "$unstaged_patch" ]; then
      # ãƒ‘ãƒƒãƒãŒã‚ã‚Œã°é©ç”¨ã—ã¦æˆ»ã™
      echo "$unstaged_patch" | git apply --whitespace=nowarn
    fi

    printf "\n"
    # æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€
    continue
  fi

  # å¤±æ•—ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
  should_fail=true

  # staging ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
  if [ ! -z "$unstaged_patch" ]; then
    # ãƒ‘ãƒƒãƒãŒã‚ã‚Œã°é©ç”¨ã—ã¦æˆ»ã™
    echo "$unstaged_patch" | git apply --whitespace=nowarn
  fi

  # SwiftFormat ã®é©ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
  echo "ğŸª¬ SwiftFormat: é©ç”¨ä¸­... $file"
  # SwiftFormat å®Ÿè¡Œ(å¤‰æ›´ãŒç™ºç”Ÿã™ã‚‹)
  $command $file
  printf "\n"
done <<< "$staged_swift_files" # while ã®å…¥åŠ›ã¨ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸ swift ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¸¡ã™

# SwiftFormat ã®å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ
if "$should_fail" ; then
  echo $(color_red "â›”ï¸ SwiftFormatã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒç”Ÿã˜ã¾ã—ãŸã€‚")
  echo "å¤‰æ›´ã‚’å–ã‚Šå…¥ã‚Œã‚‹ãªã©ã®å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"
  echo "ğŸ”— wikiã¯ã“ã¡ã‚‰ - https://..."
  exit 1
fi
